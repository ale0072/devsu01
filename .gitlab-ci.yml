stages:
  - test
  - build
  - deploy

include:
- template: Security/SAST.gitlab-ci.yml
- template: Jobs/Dependency-Scanning.gitlab-ci.yml 

variables:
  IMAGE_NAME: ale0072/devsu
  IMAGE_TAG: python-app-1

run_tests:
  stage: test
  image: python:3.11-bullseye
  before_script:
    - pip install -r requirements.txt
  script:
    - python manage.py test

build_image:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASS
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker push $IMAGE_NAME:$IMAGE_TAG

deploy:
  stage: deploy
  image: docker:20.10.16
  script:
    - apt-get update
    - apt-get install -y curl 
    - curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    - chmod +x minikube-linux-amd64
    - mv minikube-linux-amd64 /usr/local/bin/minikube
    - minikube start --driver=docker
    - minikube start --driver=virtualbox
    - kubectl apply -f kubernetes-deployment.yml

