stages:
  - test
  - build
  - deploy

include:
- template: Security/SAST.gitlab-ci.yml
- template: Jobs/Dependency-Scanning.gitlab-ci.yml 

variables:
  IMAGE_NAME: ale0072/devsu
  IMAGE_TAG: python-app-1

run_tests:
  stage: test
  image: python:3.11-bullseye
  before_script:
    - pip install -r requirements.txt
  script:
    - python manage.py test

build_image:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASS
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker push $IMAGE_NAME:$IMAGE_TAG

deploy:
  stage: deploy
  script:
    - apt-get update
    - apt-get install -y curl 
    - curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    - chmod +x minikube-linux-amd64
    - mv minikube-linux-amd64 /usr/local/bin/minikube
    - echo "deb [arch=amd64] https://download.virtualbox.org/virtualbox/debian bookworm contrib" | tee /etc/apt/sources.list.d/virtualbox.list
    - curl -s https://www.virtualbox.org/download/oracle_vbox_2016.asc | gpg --dearmor | tee /etc/apt/trusted.gpg.d/virtualbox.gpg
    - apt-get update
    - apt-get install -y virtualbox-6.1
    - apt-get install -y linux-headers-$(uname -r)  # Install Linux kernel headers
    - /sbin/vboxconfig
    - minikube start --driver=virtualbox
    - kubectl apply -f kubernetes-deployment.yml
